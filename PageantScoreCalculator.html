<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rank Conversion Calculator (1-10 Scale)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
body {
font-family: 'Inter', sans-serif;
background-color: #f7f9fc;
min-height: 100vh;
}
.container {
max-width: 1000px; /* Increased max width for the two-column layout */
margin: 0 auto;
}
.input-field {
border: 1px solid #d1d5db;
padding: 10px;
border-radius: 0.375rem;
width: 100%;
transition: border-color 0.2s;
}
.input-field:focus {
border-color: #ef4444; /* Tailwind red-500 */
outline: none;
box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5);
}
textarea.input-field {
min-height: 500px;
font-family: monospace;
white-space: pre;
overflow-wrap: normal;
}
</style>
</head>
<body class="p-4 sm:p-8">

<div class="container bg-white shadow-xl rounded-2xl p-6 md:p-10 mt-8">
<header class="text-center mb-8">
<h1 class="text-3xl font-bold text-red-600 mb-2">Pageant Rank Score Converter (120 Contestants)</h1>
<p class="text-gray-600">Calculates scores for 120 countries based on your pasted Top N list. Unranked countries receive the minimum score (1.00).</p>
</header>

<!-- Global Settings Panel -->
<div id="global-settings" class="mb-6 p-4 bg-red-50 rounded-lg border border-red-200">
<label for="totalFinalists" class="block text-lg font-semibold text-red-700 mb-2">
Total Pool Size (N):
</label>
<!-- Default N is now 120, based on the provided list size -->
<input type="number" id="totalFinalists" value="120" min="2" class="input-field text-xl font-mono text-center" oninput="window.updateScoresAndSave()">
<p class="text-sm text-red-500 mt-2">This is the total number of countries in the competition. Rank 1/N gets 10.00, Rank N/N gets 1.00.</p>
</div>

<!-- Main Input and Output Area -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

<!-- 1. Input List -->
<div class="lg:order-1">
<h2 class="text-xl font-semibold text-gray-800 mb-3">Pasted Top Rank List (Rank 1 at top)</h2>
<textarea id="rankedListInput"
class="input-field"
placeholder="Paste your ordered list here (e.g., Top 30). Each line is one rank.
The first line is Rank 1, the second is Rank 2, etc.
e.g.
Miss Philippines
Miss USA
Miss Thailand
..."
oninput="window.updateScoresAndSave()"></textarea>
<p class="text-sm text-gray-500 mt-2">Only countries listed here will receive a rank better than 120.</p>
</div>

<!-- 2. Results Table -->
<div class="lg:order-2">
<div class="flex justify-between items-center mb-3">
<h2 class="text-xl font-semibold text-gray-800">Final Weighted Scores (All 120)</h2>
<button onclick="window.copyScoresToClipboard()" id="copyButton"
class="py-2 px-4 text-sm font-medium rounded-lg shadow-sm text-white bg-red-500 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
Copy A-Z Scores Only
</button>
</div>

<div class="overflow-y-auto max-h-[500px] border rounded-lg">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50 sticky top-0">
<tr>
<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Assigned Rk</th>
<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/2">Country Name</th>
<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Score</th>
</tr>
</thead>
<tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
<!-- Results will be injected here -->
</tbody>
</table>
</div>
</div>
</div>

<!-- Status and Loading Indicator -->
<div id="statusMessage" class="text-center text-sm mt-6 font-medium text-gray-500">
Loading database connection...
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// IMPORTANT: Use provided global variables for Firebase setup
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Master List of 120 Countries (Provided by User) ---
const MASTER_COUNTRIES = [
"Albania", "Angola", "Argentina", "Armenia", "Aruba", "Australia", "Bahamas", "Bangladesh", "Belarus", "Belgium",
"Belize", "Bolivia", "Bonaire", "Botswana", "Brazil", "British Virgin Islands", "Bulgaria", "Cabo Verde", "Cambodia",
"Canada", "Cayman Islands", "Chile", "China", "Colombia", "Costa Rica", "Cote", "Croatia", "Cuba", "CuraÃ§ao",
"Czech Republic", "Denmark", "Dominican Republic", "DR Congo", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea",
"Estonia", "Finland", "France", "Ghana", "Great Britain", "Greece", "Guadeloupe", "Guatemala", "Guinea", "Guyana",
"Haiti", "Honduras", "Hong Kong", "Hungary", "India", "Indonesia", "Iraq", "Ireland", "Israel", "Italy",
"Jamaica", "Japan", "Kazakhasztan", "Korea", "Kosovo", "Kyrgyzstan", "Laos", "Latina", "Latvia", "Lebanon",
"Macau", "Malaysia", "Malta", "Martinique", "Mauritius", "Mayotte", "Mexico", "Moldova", "Myanmar", "Namibia",
"Nepal", "Netherlands", "New Zealand", "Nicaragua", "Nigeria", "Norway", "Pakistan", "Palestine", "Panama",
"Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Puerto Rico", "Romania", "Russia", "Rwanda", "Saint Lucia",
"Senegal", "Serbia", "Singapore", "Slovakia", "Slovenia", "South Africa", "Spain", "Sri Lanka", "Sweden",
"Switzerland", "Tanzania", "Thailand", "Trinidad and Tobago", "Turkiye", "Turks", "Ukraine", "United Arab Emirates",
"Uruguay", "US Virgin Islands", "USA", "Venezuela", "Vietnam", "Zambia", "Zimbabwe"
];

// Initialize Firebase variables
let app, db, auth;
let isAuthReady = false;

// UI Elements
const rankedListInput = document.getElementById('rankedListInput');
const resultsTableBody = document.getElementById('resultsTableBody');
const totalFinalistsInput = document.getElementById('totalFinalists');
const statusMessage = document.getElementById('statusMessage');

// State
let parsedResults = []; // Stores objects: {rank, country, score}

// --- Firebase Setup ---

function initializeFirebase() {
if (!firebaseConfig) {
statusMessage.textContent = 'Error: Firebase configuration missing.';
return;
}

app = initializeApp(firebaseConfig);
db = getFirestore(app);
auth = getAuth(app);

onAuthStateChanged(auth, async (user) => {
if (user) {
isAuthReady = true;
statusMessage.textContent = `Connected.`;
listenForData();
} else {
try {
if (initialAuthToken) {
await signInWithCustomToken(auth, initialAuthToken);
} else {
await signInAnonymously(auth);
}
} catch (error) {
console.error("Firebase Auth Error:", error);
statusMessage.textContent = 'Error signing into database.';
isAuthReady = true;
}
}
});
}

// --- Database Path ---

function getDocumentRef() {
const docPath = `/artifacts/${appId}/public/data/pageantScores/rankings_list_v2`; // Changed path for new structure
return doc(db, docPath);
}

// --- Data Persistence ---

function listenForData() {
if (!isAuthReady || !db) return;

const docRef = getDocumentRef();
statusMessage.textContent = 'Connecting to database...';

onSnapshot(docRef, (docSnap) => {
if (docSnap.exists()) {
const data = docSnap.data();

// 1. Load N value
const storedN = data.N || MASTER_COUNTRIES.length;
totalFinalistsInput.value = storedN;

// 2. Load the ranked list text
const storedListText = data.rankedListText || '';
rankedListInput.value = storedListText;

// 3. Process and render the loaded data
processAndRender();
statusMessage.textContent = 'Data loaded successfully.';
} else {
// Initialize with a default placeholder list
initializeRankedList();
processAndRender();
saveData(); // Save the initial blank state
statusMessage.textContent = 'New ranking list started.';
}
}, (error) => {
console.error("Firestore Listener Error:", error);
statusMessage.textContent = 'Failed to load data in real-time.';
initializeRankedList();
processAndRender();
});
}

// Debounced Save Function
let saveTimeout;
function saveData() {
if (!isAuthReady || !db) return;

clearTimeout(saveTimeout);
saveTimeout = setTimeout(async () => {
const N = parseFloat(totalFinalistsInput.value);

const dataToSave = {
N: N,
rankedListText: rankedListInput.value,
updatedAt: new Date().toISOString()
};

try {
await setDoc(getDocumentRef(), dataToSave);
statusMessage.textContent = 'Saved to database.';
} catch (e) {
console.error("Error saving document: ", e);
statusMessage.textContent = 'Error saving data.';
}
}, 500); // Wait 500ms after last change before saving
}

// --- Rank Conversion Logic (Unchanged) ---

/**
* Converts an external rank (R) out of N finalists to a score (S) from 1.0 to 10.0.
* R must be between 1 and N. If outside, it returns the minimum score (1.00).
*/
function calculateScore(rank, N) {
if (rank === null || isNaN(rank) || rank < 1 || rank > N || N <= 1) {
return 1.00; // Minimum score for unranked or out-of-bounds ranks
}

rank = parseFloat(rank);
N = parseFloat(N);

const numerator = N - rank;
const denominator = N - 1;

if (rank === 1) return 10.00;

const score = 1 + (numerator / denominator) * 9;
return score;
}

// --- Core Processing ---

function initializeRankedList() {
// Default placeholder list
const placeholder = [
"Philippines",
"USA",
"Thailand",
"Venezuela",
"South Africa",
// Placeholder for unranked
];
rankedListInput.value = placeholder.join('\n');
}

function processAndRender() {
// 1. Get N from input (should be 120 by default)
const N = parseFloat(totalFinalistsInput.value);
const maxRank = N;

// 2. Parse the pasted list into a map for fast lookup
const pastedLines = rankedListInput.value.split('\n')
.map(line => line.trim())
.filter(line => line.length > 0);

const rankedMap = new Map();
pastedLines.forEach((country, index) => {
// Rank is 1-based index
rankedMap.set(country, index + 1);
});

// 3. Build the comprehensive results list (120 entries)
parsedResults = MASTER_COUNTRIES.map((country) => {
const rank = rankedMap.get(country);

// If country is not in the pasted list, assign it the maximum rank (120)
const assignedRank = rank !== undefined ? rank : maxRank;

const scoreValue = calculateScore(assignedRank, N);

return {
rank: assignedRank,
country: country,
score: scoreValue.toFixed(2),
};
});

// 4. Render UI - render the full 120 list for visibility
renderResultsTable();
}

function renderResultsTable() {
resultsTableBody.innerHTML = '';

// Show only the top 30 ranked results in the UI table for brevity, but the CSV will be all 120.
const sortedForDisplay = parsedResults
.sort((a, b) => a.rank - b.rank) // Sort by rank (R)
.slice(0, 30); // Show only top 30 in the table

if (parsedResults.length === 0) {
resultsTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500 italic">No data to display. Check the master list.</td></tr>';
return;
}

sortedForDisplay.forEach((result) => {
const row = document.createElement('tr');
row.className = 'transition duration-75';

let scoreClass = 'text-gray-700';
if (result.rank === 1) {
scoreClass = 'text-red-600 font-bold';
} else if (result.rank === parseFloat(totalFinalistsInput.value)) {
scoreClass = 'text-gray-400 italic';
}

row.innerHTML = `
<td class="px-3 py-2 whitespace-nowrap text-sm font-semibold text-gray-900">${result.rank}</td>
<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${result.country}</td>
<td class="px-3 py-2 whitespace-nowrap text-lg ${scoreClass}">${result.score}</td>
`;
resultsTableBody.appendChild(row);
});

if (parsedResults.length > sortedForDisplay.length) {
resultsTableBody.innerHTML += `
<tr><td colspan="3" class="text-center py-2 text-gray-400">... showing top ${sortedForDisplay.length} of ${parsedResults.length} contestants. Copy button generates the full list.</td></tr>
`;
}
}

// --- Copy to Clipboard Function (FIXED: Only copies scores, sorted A-Z) ---

window.copyScoresToClipboard = function() {
if (parsedResults.length === 0) {
// Use custom message instead of alert
const button = document.getElementById('copyButton');
const originalText = button.textContent;
button.textContent = 'List is Empty!';
button.classList.add('bg-yellow-500');
setTimeout(() => {
button.textContent = originalText;
button.classList.remove('bg-yellow-500');
}, 2000);
return;
}

// 1. Sort the full 120 list alphabetically by Country Name
const sortedResults = [...parsedResults].sort((a, b) => a.country.localeCompare(b.country));

// CSV Body: Only include the weighted score for each country
let csv = '';
sortedResults.forEach(result => {
// Append only the score followed by a newline
csv += `${result.score}\n`;
});

// Use the reliable document.execCommand('copy')
fallbackCopyTextToClipboard(csv);
}

// Fallback method for copying text (for older browsers or restricted environments)
function fallbackCopyTextToClipboard(text) {
const textArea = document.createElement("textarea");
textArea.value = text;
textArea.style.position = "fixed";
textArea.style.top = "0";
textArea.style.left = "0";
textArea.style.width = "2em";
textArea.style.height = "2em";
textArea.style.padding = "0";
textArea.style.border = "none";
textArea.style.outline = "none";
textArea.style.boxShadow = "none";
textArea.style.background = "transparent";
document.body.appendChild(textArea);
textArea.focus();
textArea.select();

try {
const successful = document.execCommand('copy');
const msg = successful ? 'Scores Copied!' : 'Copying failed.';

// --- Provide visual feedback on success ---
const button = document.getElementById('copyButton');
const originalText = button.textContent;

button.textContent = msg;
if (successful) {
button.classList.remove('bg-red-500');
button.classList.add('bg-green-500');
} else {
button.classList.remove('bg-red-500');
button.classList.add('bg-yellow-500');
}

setTimeout(() => {
button.textContent = originalText;
button.classList.remove('bg-green-500', 'bg-yellow-500');
button.classList.add('bg-red-500');
}, 1500);

} catch (err) {
// Use console error instead of alert
console.error('Error executing copy command:', err);
const button = document.getElementById('copyButton');
button.textContent = 'Copy Error!';
setTimeout(() => {
button.textContent = 'Copy A-Z Scores Only';
}, 1500);
}
document.body.removeChild(textArea);
}

// --- Global Functions exposed to the DOM (called from oninput) ---
window.updateScoresAndSave = function() {
processAndRender();
saveData();
}

// Start initialization
initializeFirebase();

</script>

</body>
</html>